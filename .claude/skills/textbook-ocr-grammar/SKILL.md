---
name: textbook-ocr-grammar
description: |
  从教材OCR文件（output.md）中提取文法解说部分，修正OCR错误（特别是日文乱码），生成干净的文法.md文件。

  适用场景：
  1. 大家的日语等教材经VLM/OCR扫描后，日文严重乱码，中文解释基本可读
  2. 需要提取全部课的「文法」部分，去除练习题、图片、乱码表格
  3. 利用对教材内容的了解 + 中文翻译还原正确的日文例句

  触发词：
  - "提取文法"、"生成文法"、"文法提取" → 从output.md提取文法部分
  - "修正OCR"、"OCR修正" → 修正已提取内容的OCR错误
  - "文法.md" → 生成或更新文法.md文件

version: 1.0.0
allowed-tools: Read, Write, Edit, Glob, Grep, Task, Bash(ls *), Bash(wc *)
---

# 教材OCR文法提取助手

## 核心任务

从教材的OCR扫描文件（`output.md`）中提取全部课的文法（语法解说）部分，修正OCR错误，生成干净、可读的 `文法.md` 文件。

## 适用教材

- 大家的日语 初级1（第1-25课）→ `初级1/output.md` → `初级1/文法.md`
- 大家的日语 初级2（第26-50课）→ `初级2/output.md` → `初级2/文法.md`
- 可扩展到其他教材

## OCR特征

典型的VLM/OCR扫描问题：

| 问题类型 | 示例（OCR输出） | 正确内容 |
|---------|----------------|---------|
| 长音符号错误 | ミラ一 (一=汉字) | ミラー (ー=片假名长音) |
| 假名乱码 | 耶たし | わたし |
| 「です」乱码 | 尺、尺寸 | です |
| 「いいえ」乱码 | い元、いい元 | いいえ |
| 助词乱码 | 飞、下 | で |
| 数学公式混入 | $\frac{1}{2}$ | です |
| 随机汉字替换假名 | 也不是 | それは |
| 中文混入日文 | 有的方は | あの方は |

**关键判断**：中文解释基本可读，日文例句几乎全部需要重建。

## 工作流程

### 1. 定位文法段落

**步骤**：

1. **扫描文件结构**：用 Grep 搜索 `# 文法` 和 `# 第.*課` 标记
2. **确定每课文法段落的行范围**：从 `# 文法` 到下一个 `# 練習` 或下一课开头之间
3. **处理缺失标记**：部分课可能没有显式 `# 文法` 标记，需要在课的内容中寻找语法解说段落（通过中文解释特征识别）

```bash
# 查找所有文法标记的位置
grep -n "^# 文法" 初级1/output.md

# 查找所有课标记
grep -n "^# 第.*課" 初级1/output.md
```

### 2. 分批读取与提取

由于文件很长（通常1-2万行），分批处理：

- **批次1**：第1课～第8课
- **批次2**：第9课～第16课
- **批次3**：第17课～第25课（或更多）

每批使用一个 Task agent（subagent_type=general-purpose）并行处理，提高效率。

**Agent prompt 模板**：

```
你是「みんなの日本語」教材专家。请读取 output.md 的指定行范围，
提取文法解说部分，修正OCR错误（特别是日文例句），生成干净的markdown。

要求：
1. 保留中文语法解释，修正明显OCR错误
2. 根据中文翻译 + 教材知识还原正确的日文例句
3. 去除图片链接、练习题、乱码表格
4. 不确定的标注 [?]
5. 只保留文法解说，不包含練習A/B/C
```

### 3. 修正日文例句

修正策略（按优先级）：

1. **中文翻译反推**：根据括号中的中文翻译还原日文
2. **教材知识**：利用对「みんなの日本語」各课语法点的了解
3. **上下文推断**：根据前后文和语法点主题推断
4. **标注不确定项**：实在无法确定的用 `[?]` 标注

### 4. 去除垃圾内容

需要过滤的内容：

- `![](images/...)` 图片链接
- `<table>...</table>` 乱码表格（练习题用的）
- 練習A/B/C 的所有内容
- 纯数字/符号乱码行
- LaTeX 数学公式（如 `$\rightarrow$`）
- 重复的假名表/五十音

### 5. 合并输出

将所有批次的结果合并为一个文件。

## 输出格式

```markdown
# 初级X 文法解说

---

## 第1課

### 1. 语法点标题（日文形式）

[中文语法解释]

① 日文例句。（中文翻译。）

② 日文例句。（中文翻译。）

[注] 补充说明（如有）

### 2. 下一个语法点

...

---

## 第2課

...
```

**格式规则**：

- 用 `## 第N課` 分课
- 用 `### N. 语法点` 分语法点
- 用 `---` 分隔不同课
- 例句用圈号 ①②③④⑤⑥⑦⑧⑨⑩⑪⑫⑬⑭⑮⑯⑰⑱⑲⑳ 编号
- 中文翻译紧跟日文例句，用括号（）包裹
- 日文使用全角标点
- 表格用标准 markdown 表格语法
- 保留 `[注]` 标记的注释说明

## 验证清单

生成完成后需验证：

- [ ] 所有课（如初级1的25课）是否齐全
- [ ] 每课的语法点数量是否合理（参照教材目录）
- [ ] 抽查3-5课的日文例句是否正确
- [ ] 没有残留的图片链接、练习题、乱码内容
- [ ] 格式统一（标题层级、编号、分隔线）

## 各教材语法点速查

### 大家的日语 初级1（第1-25课）

| 课 | 主要语法点 |
|----|-----------|
| 1 | 名詞は名詞です、じゃありません、ですか、も、の、さん |
| 2 | これ/それ/あれ、この/その/あの、そうです、か～か、の（代替） |
| 3 | ここ/そこ/あそこ、場所です、どこ/どちら、いくら |
| 4 | 時間、動詞ます/ません/ました、に（時間）、から～まで、と、ね |
| 5 | へ行きます/来ます/帰ります、で（交通）、と（人）、いつ、よ |
| 6 | を（他動詞）、をします、なん/なに、で（場所）、ませんか、ましょう |
| 7 | で（道具）、～語で何ですか、あげます/もらいます、もう～ました |
| 8 | い形容詞/な形容詞、否定形、修飾、が（転折）、とても/あまり、どう/どんな |
| 9 | 好き/嫌い/上手/下手/わかります/あります（が）、から、どうして |
| 10 | あります/います、場所に～が、～は場所に、位置語、や |
| 11 | 数量詞、助数詞、に～回、だけ |
| 12 | 過去形（名詞/形容詞）、比較（より）、最上級（いちばん） |
| 13 | 欲しい、～たい、～に行きます、どこか/何か、ご～ |
| 14 | 動詞グループ、て形、～てください、～ています、ましょうか |
| 15 | ～てもいいですか、～てはいけません、～ています（状態）、に（着点） |
| 16 | て形連接（動詞/形容詞/名詞）、～てから、は～が形容詞、を（離点）、どうやって |
| 17 | ない形、～ないでください、～なければなりません、～なくてもいいです、までに |
| 18 | 辞書形、～ことができます、趣味は～こと、～前に、なかなか、ぜひ |
| 19 | た形、～たことがあります、～たり～たりします、なります |
| 20 | 敬体と普通体、普通形の作り方、普通体での会話 |
| 21 | ～と思います、～と言いました、でしょう？、で（場所）あります、でも、～ないと |
| 22 | 連体修飾節、辞書形＋時間/約束/用事 |
| 23 | ～とき、～と（条件）、を（移動動詞の経路） |
| 24 | くれます、～てあげます/もらいます/くれます |
| 25 | ～たら、～ても、もし、従属節の主語は「が」 |

## 使用示例

### 示例1：初次提取

**用户**："帮我从初级1的output.md提取文法部分"

**执行**：
1. 读取 `初级1/output.md`，扫描结构
2. 定位所有25课的文法段落行范围
3. 启动3个并行 agent 分别处理第1-8课、第9-16课、第17-25课
4. 合并结果，写入 `初级1/文法.md`
5. 验证25课是否齐全

### 示例2：单课修正

**用户**："第12课的文法好像有问题，帮我修正一下"

**执行**：
1. 读取 `初级1/文法.md` 中第12课部分
2. 对照教材知识检查日文例句
3. 修正错误内容
4. 用 Edit 工具原地更新

### 示例3：新教材

**用户**："初级2的output.md也扫描好了，提取文法"

**执行**：
1. 读取 `初级2/output.md`，确认课号范围（第26-50课）
2. 同样流程分批提取
3. 写入 `初级2/文法.md`

## 注意事项

- **不要凭空编造**：修正OCR时优先参考原文的中文翻译，不确定的标注 `[?]`
- **保持简洁**：只提取文法解说，不包含练习、会话、单词等其他部分
- **并行处理**：文件很长时务必分批并行，不要试图一次处理整个文件
- **教材知识辅助**：充分利用对「みんなの日本語」教材内容的了解来还原日文
- **中文翻译可靠**：OCR的中文部分相对可靠，是还原日文的关键线索
